import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;

import org.alfresco.service.ServiceRegistry;
import org.alfresco.service.cmr.repository.NodeRef;
import org.alfresco.service.cmr.repository.NodeService;
import org.alfresco.service.cmr.repository.StoreRef;
import org.alfresco.service.namespace.QName;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.opencsv.CSVReader;
import com.opencsv.CSVWriter;
import com.opencsv.exceptions.CsvValidationException;

public class UpdateDocDescScheduledJobExecuter {

    private static final Logger logger = LoggerFactory.getLogger(UpdateDocDescScheduledJobExecuter.class);

    // ... (other constants and fields)

    public void execute() {
        logger.info("Running the Update Document Description Scheduled Job Executer");
        try {
            File[] csvFiles = updateDocDescCSVProcessor.getCSVReports();

            if (csvFiles.length > 0) {
                int numFilestoPick = Math.min(1, csvFiles.length);
                for (int i = csvFiles.length - 1; i >= csvFiles.length - numFilestoPick; i--) {
                    boolean hasAnyFailures = false;
                    File csvFile = csvFiles[i];
                    String inputFilePath = csvFile.getAbsolutePath();

                    String successFilePath = updateDocDescCSVProcessor.getSOURCE_CSV_LOC() + "/"
                            + CommonConstants.SUCCESS_CSV_LOC_NAME + "/" + csvFile.getName();
                    String failureFilePath = updateDocDescCSVProcessor.getSOURCE_CSV_LOC() + "/"
                            + CommonConstants.ERROR_CSV_LOC_NAME + "/" + csvFile.getName();

                    try (CSVReader reader = new CSVReader(new FileReader(inputFilePath));
                            CSVWriter successFilewriter = new CSVWriter(new FileWriter(successFilePath));
                            CSVWriter failureFilewriter = new CSVWriter(new FileWriter(failureFilePath))) {

                        String[] header = reader.readNext();
                        String[] newHeader = addColumn(header, "Status");

                        successFilewriter.writeNext(newHeader);
                        failureFilewriter.writeNext(newHeader);

                        String[] nextLine;
                        ExecutorService executor = Executors.newFixedThreadPool(4); // Adjust the number of threads as needed
                        while ((nextLine = reader.readNext()) != null) {
                            String[] row = nextLine;

                            // Process each row in a separate thread
                            executor.submit(() -> processAndWriteRow(row, header, successFilewriter, failureFilewriter));

                            // Wait for half a second before moving to the next job
                            Thread.sleep(100);
                        }
                        executor.shutdown();
                        executor.awaitTermination(Long.MAX_VALUE, TimeUnit.NANOSECONDS);
                    } catch (IOException | CsvValidationException e) {
                        logger.error("Error processing CSV file: " + e.getMessage(), e);
                    } finally {
                        // ... (rest of the code)
                    }
                    // Adding a sleep time for 10 seconds
                    Thread.sleep(10000);
                }
            } else {
                logger.info("No document found under " + updateDocDescCSVProcessor.getSOURCE_CSV_LOC()
                        + " for Update Document Description Stateful JobScheduler");
            }
        } catch (Exception e) {
            logger.error("Error while processing the csv batches: " + e.getMessage(), e);
        }
    }

    private void processAndWriteRow(String[] row, String[] header, CSVWriter successFilewriter,
            CSVWriter failureFilewriter) {
        String[] processedRow = processRow(row);

        if (processedRow != null && processedRow.length > header.length) {
            String status = processedRow[header.length];

            if ("Success".equalsIgnoreCase(status)) {
                successFilewriter.writeNext(processedRow);
            } else {
                failureFilewriter.writeNext(processedRow);
            }
        }
    }

    // ... (rest of the code)

}
